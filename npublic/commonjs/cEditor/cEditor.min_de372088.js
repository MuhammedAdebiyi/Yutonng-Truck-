"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var o=t[n];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}$define(["css!/npublic/commonjs/cEditor/cEditor","pl_util","/npublic/commonjs/emoji/emoji.js","/npublic/commonjs/nouglify/recording/recording.js"],function(e,t,o,a){return function(){function t(e){_classCallCheck(this,t),this.option=$.extend({element:".cEditor",height:200,windowStyle:1,voiceSwitch:0,showEmoji:!0,btn:["emoji"],onchange:function(){},onenter:function(){}},e),1==this.option.voiceSwitch&&this.option.btn.push("makphone"),this.btnGroup={emoji:{icon:'<svg t="1723618435696" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1178" width="200" height="200"><path d="M511.957337 1024C229.612866 1024 0 794.344471 0 511.957337 0 229.655529 229.612866 0 511.957337 0s511.957337 229.655529 511.957337 511.957337c0 282.387134-229.612866 512.042663-511.957337 512.042663zM511.957337 68.260978C267.284393 68.260978 68.260978 267.284393 68.260978 511.957337c0 244.715607 199.023415 443.781685 443.696359 443.781685S955.653696 756.672944 955.653696 511.957337c0-244.715607-199.023415-443.696359-443.696359-443.696359z" p-id="1179"></path><path d="M511.957337 819.174402a304.657279 304.657279 0 0 1-219.373719-92.237647A305.126573 305.126573 0 0 1 204.782935 511.957337a34.130489 34.130489 0 0 1 34.130489-34.130489h546.087826a34.130489 34.130489 0 0 1 34.130489 34.130489c0 80.846596-31.144071 157.213566-87.800683 214.936755A304.657279 304.657279 0 0 1 511.957337 819.131739z m-170.652446-139.935005a236.908258 236.908258 0 0 0 170.652446 71.674027 237.334889 237.334889 0 0 0 170.652446-71.674027 237.633531 237.633531 0 0 0 65.786517-133.108908H275.518373A237.292226 237.292226 0 0 0 341.304891 679.239397z m17.065245-269.630864a51.195734 51.195734 0 1 1 0-102.434131 51.195734 51.195734 0 0 1 0 102.391468z m307.174402 0a51.195734 51.195734 0 1 1 0-102.391468 51.195734 51.195734 0 0 1 0 102.391468z" p-id="1180"></path></svg>'},makphone:{icon:'<svg t="1758531906053" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5861" width="128" height="128"><path d="M469.632 808.064A341.376 341.376 0 0 1 170.666667 469.333333h85.333333a256 256 0 0 0 256 256h1.749333A256 256 0 0 0 768 469.333333h85.333333a341.376 341.376 0 0 1-298.368 338.645334l0.426667 130.56-85.333333 0.256-0.426667-130.730667zM512 128a85.333333 85.333333 0 0 0-85.333333 85.333333v256a85.333333 85.333333 0 1 0 170.666666 0V213.333333a85.333333 85.333333 0 0 0-85.333333-85.333333z m0-85.333333a170.666667 170.666667 0 0 1 170.666667 170.666666v256a170.666667 170.666667 0 1 1-341.333334 0V213.333333a170.666667 170.666667 0 0 1 170.666667-170.666666z" p-id="5862"></path><path d="M341.333333 981.333333v-85.333333h341.333334v85.333333z" p-id="5863"></path></svg>'}},this.element=$(this.option.element),this.element.addClass("cEditor"),this.savedRange=null,this.recodeTimeout=null,this.init()}return _createClass(t,[{key:"init",value:function(){var t=this,e='\n                <div class="cEditor-content" style="height:'.concat(this.option.height,'px">\n                    <div class="cEditor-area" contenteditable="true" placeholder="').concat(i18n.sms_placeholder,'"></div>\n                </div>\n                <div class="cEditor-oprate"></div>\n            ');2==this.option.windowStyle&&(e='\n                    <div class="cEditor-content">\n                        <input type="text" class="cEditor-area" placeholder="'.concat(i18n.sms_placeholder,'" />\n                    </div>\n                ')),this.element.html(e),this.area=this.element.find(".cEditor-area"),1==this.option.windowStyle?(this.renderBtn(),this.area.on("keydown",function(e){e.ctrlKey||13!=e.keyCode?e.ctrlKey&&13==e.keyCode&&(e.preventDefault(),document.execCommand("insertParagraph",!1,null),t.area.parent().scrollTop(99999)):e.preventDefault()}),this.area.on("keyup",function(e){e.ctrlKey||13!=e.keyCode||t.option.onenter(),t.option.onchange(t.getData())}),this.area.on("paste",function(e){!function(e){e=e||window.event;e.preventDefault();e=(e=(e.originalEvent||e).clipboardData.getData("text/plain")).replace(/\[\d+\]|\n|\r/gi,"");document.execCommand("insertText",!1,e)}(e),t.option.onchange(t.getData()),t.area.parent().scrollTop(99999)})):(this.area.on("keydown",function(e){13==e.keyCode&&(t.option.onenter(),e.preventDefault())}),this.area.on("input",function(e){t.option.onchange(t.getData())}))}},{key:"makphoneStatus",value:function(e,t){1==t?(e.addClass("loading").removeClass("active"),this.element.find(".con-makphone").text("正在获取当前浏览器的麦克风权限").show(),e.html('<svg t="1758707135210" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15282" width="128" height="128"><path d="M853.344 512c0 187.744-153.6 341.344-341.344 341.344S170.656 699.744 170.656 512 324.256 170.656 512 170.656V85.312c-234.656 0-426.656 192-426.656 426.656s192 426.656 426.656 426.656 426.656-192 426.656-426.656h-85.344z" p-id="15283"></path></svg>')):2==t?(e.addClass("active").removeClass("loading"),this.element.find(".con-makphone").text("录音中，点击停止录音，最多支持30秒").show(),e.html('<svg t="1758694556559" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="12075" width="128" height="128"><path d="M160 640h-64V384h64v256z m768-256h-64v256h64V384z m-576-64h-64v384h64V320z m384 0h-64v384h64V320zM544 192h-64v640h64V192z" p-id="12076"></path></svg>')):3==t?(e.removeClass("active").removeClass("loading").removeClass("stopLoading"),this.element.find(".con-makphone").hide(),e.html('<svg t="1758531906053" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5861" width="128" height="128"><path d="M469.632 808.064A341.376 341.376 0 0 1 170.666667 469.333333h85.333333a256 256 0 0 0 256 256h1.749333A256 256 0 0 0 768 469.333333h85.333333a341.376 341.376 0 0 1-298.368 338.645334l0.426667 130.56-85.333333 0.256-0.426667-130.730667zM512 128a85.333333 85.333333 0 0 0-85.333333 85.333333v256a85.333333 85.333333 0 1 0 170.666666 0V213.333333a85.333333 85.333333 0 0 0-85.333333-85.333333z m0-85.333333a170.666667 170.666667 0 0 1 170.666667 170.666666v256a170.666667 170.666667 0 1 1-341.333334 0V213.333333a170.666667 170.666667 0 0 1 170.666667-170.666666z" p-id="5862"></path><path d="M341.333333 981.333333v-85.333333h341.333334v85.333333z" p-id="5863"></path></svg>')):4==t&&(e.removeClass("active").removeClass("loading").addClass("stopLoading"),this.element.find(".con-makphone").text("正在识别语音内容").show(),e.html('<svg t="1758707135210" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15282" width="128" height="128"><path d="M853.344 512c0 187.744-153.6 341.344-341.344 341.344S170.656 699.744 170.656 512 324.256 170.656 512 170.656V85.312c-234.656 0-426.656 192-426.656 426.656s192 426.656 426.656 426.656 426.656-192 426.656-426.656h-85.344z" p-id="15283"></path></svg>'))}},{key:"renderBtn",value:function(){var n=this;this.option.btn.forEach(function(t){n.element.find(".cEditor-oprate").append('<button class="op-btn '.concat(t,'">').concat(n.btnGroup[t].icon,"</button>")),n.element.find(".cEditor-oprate").append('<div class="op-con con-'.concat(t,'"></div>')),n.handleBar(t),n.element.on("click",".".concat(t),function(e){"emoji"==t?(n.focus(),n.saveSelection(),0==n.savedRange.startOffset&&0==n.savedRange.endOffset&&(n.placeCursorAtEnd(),n.saveSelection()),n.opClick(t)):"makphone"==t&&(navigator.getUserMedia?$(e.currentTarget).hasClass("loading")||$(e.currentTarget).hasClass("stopLoading")||(n.focus(),n.saveSelection(),$(e.currentTarget).hasClass("active")?n.stopRecord(e):n.startRecord(e)):$.pl_toast({msg:"您的浏览器不支持录音功能！"}))})}),$(document).click(function(e){var t=n.element.find(".op-btn");t.is(e.target)||0!==t.has(e.target).length||n.element.find(".op-con.con-emoji").hide()})}},{key:"startRecord",value:function(t){var n=this;this.makphoneStatus($(t.currentTarget),1),this.recording.startRecording(function(e){"error"!=e?(n.makphoneStatus($(t.currentTarget),2),n.recodeTimeout=setTimeout(function(){n.stopRecord(t)},3e4)):n.makphoneStatus($(t.currentTarget),3)})}},{key:"stopRecord",value:function(n){var o=this;this.recodeTimeout&&clearTimeout(this.recodeTimeout),this.makphoneStatus($(n.currentTarget),4),this.recording.stopRecording(function(e){o.makphoneStatus($(n.currentTarget),3);try{var t=e.data.result[0];o.focus(),document.execCommand("insertText",!1,t),o.option.onchange(o.getData())}catch(e){}})}},{key:"handleBar",value:function(t){var n=this;"emoji"==t?o.init({ele:this.element.find(".cEditor-oprate .con-emoji"),onClick:function(e){n.element.find(".con-".concat(t)).hide();e=o.symbolToEmoji(e);n.insertEmoji(e)}}):"makphone"==t&&(this.recording=new a)}},{key:"placeCursorAtEnd",value:function(){var e=this.area[0],t=document.createRange(),n=window.getSelection();t.selectNodeContents(e),t.collapse(!1),n.removeAllRanges(),n.addRange(t)}},{key:"saveSelection",value:function(){var e=window.getSelection();0<e.rangeCount&&(this.savedRange=e.getRangeAt(0))}},{key:"restoreSelection",value:function(){var e;this.savedRange&&((e=window.getSelection()).removeAllRanges(),e.addRange(this.savedRange))}},{key:"insertEmoji",value:function(e){this.restoreSelection(),document.execCommand("insertText",!1,e),this.option.onchange(this.getData()),this.area.parent().scrollTop(99999),this.savedRange=null}},{key:"opClick",value:function(e){"emoji"==e&&this.element.find(".con-".concat(e)).toggle()}},{key:"getData",value:function(){return 1==this.option.windowStyle?o.htmlToSymbol(this.area.html()):this.area.val()}},{key:"clear",value:function(){this.area.val(""),this.area.html(""),this.option.onchange(this.getData())}},{key:"focus",value:function(){this.area.focus()}}]),t}()});