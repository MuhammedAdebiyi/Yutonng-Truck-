"use strict";function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);return"Object"===a&&e.constructor&&(a=e.constructor.name),"Map"===a||"Set"===a?Array.from(e):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?_arrayLikeToArray(e,t):void 0}}function _iterableToArray(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}$define(["formUtil","bootstrap","cmsAjax","pl_util","pl_toast","treeSelect"],function(I,e,j,t,a,n){return{init:function(){var e=this._params,a=e.id,u=this.scope,c=e.propJson,r=c.datasource,n=c.ccsource,o=[],i={},s={},d=[],l={},p=10,h=1,f=[],_=u.closest("[class^=e_subForm-]"),g=0<_.length;0==c.searchList.length&&u.find(".p_searchCon").hide();var v,t,m,y=$.getSearch();function k(e){var a,n=e;"true"==y.sku&&(n=[],a=function(e){var t=localStorage.getItem("skuFloatData_"+tenant.tenantId)||"{}";(t=JSON.parse(t))[e]||(t[e]={});return t[e]}(y.pid)[y.type],e.forEach(function(e,t){-1<a.indexOf(e.skuId)&&n.push(e)})),n.forEach(function(a){var n=[],o="";d.forEach(function(e){var t;e.inIdentity&&"checkbox_item"==e.k&&(o=e.outCode),"checkbox_item"==e.k||!e.tableShow&&1!=c.type||(t=I.getListContent(e,a),n.push('<td datakey="'.concat(e.outCode,"\" datavalue='").concat(I.getListContent(e,a,!0),'\'>\n                            <div class="p_listWord">').concat(t,"</div>\n                        </td>")))}),g||!1===c.removeBtn||n.push('<td class="op">\n                        <a class="p_remove_fixed" href="javascript:;">'.concat(i18n.form_remove,"</div>\n                    </td>")),u.find(".p_tabelList tbody").append('\n                    <tr datakey="'.concat(o,'" datavalue="').concat(a[o],"\" dataObj='").concat(escape(JSON.stringify(a)),"'>\n                        ").concat(n.join(""),"\n                    </tr>\n                "))})}function b(e){j.cmsAjax.postJson(r.api,e).then(function(e){e&&e.data&&e.data.list&&(g?_.trigger("receaveData",{list:e.data.list,col:d}):k(e.data.list))})}function C(){var t=JSON.parse(JSON.stringify(r.params));t.from=(h-1)*p,t.size=p,t.query=[],o.forEach(function(e){t.query.push(e)}),i.value&&t.query.push(i),j.cmsAjax.postJson(r.api,t).then(function(e){var t,a;e.data&&e.data.list&&(f=e.data.list,t=[],a=[],u.find(".p_tabelList tbody tr").each(function(){a.push({k:$(this).attr("datakey"),v:$(this).attr("datavalue")})}),f.forEach(function(n){var o=[];d.forEach(function(t){var e,a;t.inIdentity&&"checkbox_item"==t.k?(a=e="",o.find(function(e){return e.k==t.outCode&&e.v==t.outCode})&&(e="disabled",a="checked"),o.push('<td class="p_listSelect">\n                                    <input type="checkbox" class="checkedInput" '.concat(e," ").concat(a,' name="').concat(t.outCode,'" value="').concat(n[t.outCode],'">\n                                </td>'))):(a=I.getListContent(t,n),o.push('<td>\n                                    <div class="p_listWord" name="'.concat(t.outCode,'">').concat(a,"</div>\n                                </td>")))}),t.push("\n                            <tr>\n                                ".concat(o.join(""),"\n                            </tr>\n                        "))}),u.find(".p_tabel tbody").html(t.join("")),function(e){var t=Math.ceil(e.from/e.size)+1,a=e.size,n=Math.ceil(e.totalCount/a),o=[],c="",e=1==t?"disabled":"",a=t==n?"disabled":"";if(n<8)for(var r=1;r<=n;r++){var i=r==t?"current":"";o.push('<a class="page_a page_num '.concat(i,'"  page="').concat(r,'" href="javascript:;">').concat(r,"</a>"))}else if(t<=3){for(var s=1;s<=4;s++){var d=s==t?"current":"";o.push('<a class="page_a page_num '.concat(d,'"  page="').concat(s,'" href="javascript:;">').concat(s,"</a>"))}o.push('<span class="page_a page_ellipsis">...</span>'),o.push('<a class="page_a page_num" page="'.concat(n,'" href="javascript:;">').concat(n,"</a>"))}else if(n-2<=t){o.push('<a class="page_a page_num" page="1" href="javascript:;">1</a >'),o.push('<span class="page_a page_ellipsis">...</span>');for(var l=n-3;l<=n;l++){var p=l==t?"current":"";o.push('<a class="page_a page_num '.concat(p,'"  page="').concat(l,'" href="javascript:;">').concat(l,"</a>"))}}else o.push('<a class="page_a page_num" page="1" href="javascript:;">1</a >'),o.push('<span class="page_a page_ellipsis">...</span>'),o.push('<a class="page_a page_num" page="'.concat(t-1,'" href="javascript:;">').concat(t-1,"</a >")),o.push('<a class="page_a page_num current" page="'.concat(t,'" href="javascript:;">').concat(t,"</a >")),o.push('<a class="page_a page_num" page="'.concat(t+1,'" href="javascript:;">').concat(t+1,"</a >")),o.push('<span class="page_a page_ellipsis">...</span>'),o.push('<a class="page_a page_num" page="'.concat(n,'" href="javascript:;">').concat(n,"</a >"));c='\n                <a href="javascript:;" class="page_a page_prev '.concat(e,'">&lt;</a >\n                ').concat(o.join(""),'\n                <a href="javascript:;" class="page_a page_next ').concat(a,'">&gt;</a >\n            '),u.find(".p_listPage").html(c)}(e.data.page))})}g&&u.find(".p_addContent").hide(),u.on("addRelevant",".p_addContent",function(e,t){v=t,$(this).trigger("click")}),u.on("change","#p_selectAll",function(){$(this).prop("checked")?u.find(".checkedInput").prop("checked",!0):u.find(".checkedInput").prop("checked",!1)}),u.on("change",".checkedInput",function(){u.find(".checkedInput").length==u.find(".checkedInput:checked").length?u.find("#p_selectAll").prop("checked",!0):u.find("#p_selectAll").prop("checked",!1)}),u.on("click",".page_num",function(){$(this).hasClass("current")||($(this).addClass("disabled"),h=Number($(this).attr("page")),C())}),u.on("click",".page_prev",function(){$(this).hasClass("disabled")||($(this).addClass("disabled"),--h,C())}),u.on("click",".page_next",function(){$(this).hasClass("disabled")||($(this).addClass("disabled"),h+=1,C())}),u.on("click",".p_addContent",function(){r.metaUrl&&isFrontEnv()?(u.find(".p_searchInput").val(""),o=[],C(),u.find("#"+a+"-relevantModal").modal("show")):$.pl_toast({msg:i18n.form_noDatasource}),n.url?j.cmsAjax.postJson(n.urlAttrs.meta).then(function(e){try{var t=e.data.responseArgs.find(function(e){return"list"==e.outCode});l=t.children.find(function(e){return 1==e.inIdentity}),j.cmsAjax.postJson(n.url).then(function(e){try{var t=function t(e,a){e.forEach(function(e){n.push({zhid:e[l.outCode],pId:a,id:e.CID,name:e.categoryName}),e.children&&0<e.children.length&&t(e.children,e.CID)})},n=[{zhid:0,pId:0,id:"asd",name:i18n.form_allCategory}];e.data.list.forEach(function(e){n.push({zhid:e[l.outCode],pId:0,id:e.CID,name:e.categoryName}),e.children&&0<e.children.length&&t(e.children,e.CID)}),u.find(".treeSelect").empty().treeSelect({data:n,inputId:a+"txt",placeholder:i18n.form_selectCategory,callback:function(e,t,a){!function(e){i=0==e.zhid?{}:{esField:s.outEsCode,field:s.outCode,logic:"and",operator:"eq",sourceType:"static",value:e.zhid};C()}(a)}})}catch(e){}})}catch(e){}}):u.find(".p_categoryCon").hide()}),u.on("click",".p_searchBtn",function(){var a=u.find(".p_searchInput").val(),n=[];c.searchList.forEach(function(e,t){e={logic:0==t?"and":"or",field:e.key,esField:e.esField,operator:"like",sourceType:"static",value:a.trim()};1<c.searchList.length&&(0==t&&(e.groupBegin="1"),t==c.searchList.length-1&&(e.groupEnd="1")),n.push(e)}),o=n,h=1,C()}),u.on("click",".p_confirm",function(){var n=[];u.find(".checkedInput:checked").each(function(){var t=$(this).attr("name"),a=$(this).val(),e=f.find(function(e){return e[t]==a});e&&(delete e.content,n.push(e))}),0<n.length?(g&&v?v(n,d):k(n),u.find("#"+a+"-relevantModal").modal("hide"),u.find(".checkedInput").prop("checked",!1)):$.pl_toast({msg:i18n.form_selectData})}),u.on("click",".p_remove_fixed",function(){$(this).parents("tr").remove()}),function(){var e=g||!1===c.removeBtn?[]:[{label:i18n.form_action,key:"remove_fixed"}],t=[].concat(_toConsumableArray(c.previewList),e);{var a,n;g?(u.find(".p_tabelList thead").hide(),e=u.parents(".p_td").index(),a=[],t.forEach(function(e){!e.tableShow&&1!=c.type||a.push('<div class="p_relevantTd" style="flex:0 0 '.concat(e.width,'%">').concat(e.nick||e.label,"</div>"))}),_.find(".p_thead .p_th").eq(e).html('<div class="p_relevantCon" style="display:flex">\n                        '.concat(a.join(""),"\n                    </div>"))):(n=[],t.forEach(function(e){"remove_fixed"!=e.key&&!e.tableShow&&1!=c.type||n.push('<td width="'.concat(e.width,'%">').concat(e.nick||e.label,"</td>"))}),u.find(".p_tabelList thead").html("<tr>\n                        ".concat(n.join(""),"\n                    </tr>")))}}(),t=[{label:i18n.form_select,key:"checkbox_fixed"}],t=[].concat(t,_toConsumableArray(c.previewList)),m=[],t.forEach(function(e){var t="";"checkbox_fixed"==e.key&&(t="p_listSelect"),m.push('<td scope="col" class="'.concat(t,'">').concat(e.nick||e.label,"</td>"))}),u.find(".p_tabel thead").html("<tr>\n                    ".concat(m.join(""),"\n                </tr>")),r.metaUrl&&isFrontEnv()&&j.cmsAjax.get(r.metaUrl).then(function(e){var a,n,o;e.data&&e.data.responseArgs&&((a=e.data.responseArgs.find(function(e){return"list"==e.outCode}))&&((e="143150160001"==a.inAppId?a.children.find(function(e){return 1==e.isCategory&&"categoryId"==e.outCode}):a.children.find(function(e){return 1==e.isCategory}))&&(s=e),(e=a.children.find(function(e){return 1==e.inIdentity}))&&d.push({k:"checkbox_item",inIdentity:e.inIdentity,outCnname:e.outCnname,outCode:e.outCode,outEsCode:e.outEsCode,outType:e.outType}),c.previewList.forEach(function(t){var e=a.children.find(function(e){return e.outCode==t.key});e?d.push({width:t.width,tableShow:1==c.type||t.tableShow,inIdentity:e.inIdentity,outCnname:e.outCnname,outCode:e.outCode,outEsCode:e.outEsCode,outType:e.outType,openLink:t.openLink,linkTarget:t.linkTarget}):d.push({})}),c.listParams?(n=r.params,o=!1,n.size=100,n.query.forEach(function(e,t){y[e.value]?(n.query[t].value=y[e.value],o=!0):"_detailId"==e.value?window.pageObj._detailId?(n.query[t].value=pageObj._detailId,o=!0):window.location.pathname.split("/").forEach(function(e){/^(\d|-)+(\.html)$/.test(e)&&(n.query[t].value=e.split(".")[0],n.query[t].value=n.query[t].value.split("-")[0],o=!0)}):n.query[t].value=""}),o&&b(n)):y[e.outCode]&&b({from:0,size:10,query:[{logic:"and",field:e.outCode,esField:e.outEsCode,operator:"eq",sourceType:"static",value:y[e.outCode],groupBegin:"1",groupEnd:"1"}]})))})}}});